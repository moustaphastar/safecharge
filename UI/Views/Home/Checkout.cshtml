@model UI.SafeChargeModels.OpenOrderResponse
@{
    ViewBag.Title = "Checkout Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .SfcFields {
        background-color: #feff8c;
        height: 42px;
        padding: 10px 12px;
        border-radius: 4px;
        /*border: 1px solid transparent;*/
        box-shadow: 0 1px 3px 0 #e6ebf1;
        -webkit-transition: box-shadow 150ms ease;
        transition: box-shadow 150ms ease;
        min-height: 30px;
        border: 1px solid #ccc;
        border-radius: 3px;
        padding: 3px;
    }

    .sfc-empty {
        background-color: #fecd58 !important;
    }

        .sfc-empty.sfc-focus {
            box-shadow: 0 1px 3px 0 #cfd7df;
            background-color: #fe8423 !important;
        }

    .sfc-focus {
        box-shadow: 0 1px 3px 0 #cfd7df;
        background-color: #feb1c7 !important;
    }

    .sfc-complete {
        background-color: #34fa29 !important;
    }

    .sfc-invalid {
        border-color: #fa755a;
    }

    .SfcFields--webkit-autofill {
        background-color: #fefde5 !important;
    }
</style>

<!-- Start Checkout -->
<section class="shop checkout section">
    <div class="container">
        <div class="row">
            <div class="col-6 m-sm-auto">
                <div class="order-details">
                    <!-- Order Widget -->
                    <div class="single-widget">
                        <h2>Checkout Details</h2>
                        <div class="content">
                            <ul>
                                <li>Amount to pay<span id="checkoutTotal">$@String.Format("{0:c}", ViewBag.AuthorizedAmount)</span></li>
                            </ul>
                        </div>
                    </div>
                    <!--/ End Order Widget -->
                    <!-- Payment Method Widget -->
                    <div class="single-widget">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="cardNumber">Card Number</label>
                                <select class="form-control form-control-sm" id="cardSelect" onchange="cardSelected()">
                                    <optgroup label="3DS v2 Frictionless Flow Test Cards">
                                        <option selected="selected">4000027891380961</option>
                                    </optgroup>
                                    <optgroup label="3DS v2 Challenge Flow Test Cards">
                                        <option>2221008123677736</option>
                                    </optgroup>
                                    <optgroup label="Simple Auth">
                                        <option>4000020951595032</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cardHolderName">Card Holder Name</label>
                                <input type="text" id="cardHolderName" class="col-12" placeholder="FL-BRW1" value="FL-BRW1" />
                            </div>
                            <div class="form-group">
                                <label for="expMonth">Expiry Month</label>
                                <input type="text" id="expMonth" class="col-12" placeholder="12" value="12" />
                            </div>
                            <div class="form-group">
                                <label for="expYear">Expiry Year</label>
                                <input type="text" id="expYear" class="col-12" placeholder="25" value="25" />
                            </div>
                            <div class="form-group">
                                <label for="CVV">CVV</label>
                                <input type="text" id="CVV" class="col-12" placeholder="217" value="217" />
                            </div>
                        </div>
                    </div>
                    <!--/ End Payment Method Widget -->
                    <!-- Button Widget -->
                    <div class="single-widget get-button">
                        <div class="content">
                            <div class="button">
                                <button id="payoutButton" onclick="main();" class="btn btn-primary">Submit Payment</button>
                            </div>
                        </div>
                    </div>
                    <!--/ End Button Widget -->
                </div>

            </div>
        </div>
    </div>
</section>
<!--/ End Checkout -->
<!-- Fingerprinting-->
<form id="fingerprintform" name="frm" method="POST" action="" target="fingerprintiframe">
    <input type="hidden" id="fingerprintinput" name="threeDSMethodData" value="">
</form>
<!-- when the form is submitted, the server response will appear in this iframe -->
<iframe id="fingerprintiframe" name="fingerprintiframe" src="https://3dsn.sandbox.safecharge.com/ThreeDSMethod/api/ThreeDSMethod/threeDSMethodURL" width="0" height="0">
</iframe>
<!--/ End Fingerprinting -->

@section Scripts{
    <script src="https://cdn.safecharge.com/safecharge_resources/v1/websdk/safecharge.js"></script>
    <script>
        function main() {
            var cardholderName = document.getElementById('cardHolderName').value;
            var cardNumber = document.getElementById('cardSelect').value;
            var expMonth = document.getElementById('expMonth').value;
            var expYear = document.getElementById('expYear').value;
            var CVV = document.getElementById('CVV').value;
            var amount = "@String.Format("{0:c}", ViewBag.AuthorizedAmount)";
            var currency = "@ViewBag.Currency";
            var timestamp = "@ViewBag.TimeStmap";
            var checksum = "@ViewBag.Checksum"
            var checksumForPayment = "@ViewBag.ChecksumForPayment"

            var request =
            {
                "sessionToken": "@Model.SessionToken",
                "merchantId": "@Model.MerchantId",
                "merchantSiteId": "@Model.MerchantSiteId",
                "userTokenId": "@Model.UserTokenId",
                "clientUniqueId": "@Model.ClientUniqueId",
                "clientRequestId" :"@Model.ClientRequestId",
                "amount": amount,
                "currency": currency,
                "paymentOption": {
                    "card": {
                        "cardNumber": cardNumber,
                        "cardHolderName": cardholderName,
                        "expirationMonth": expMonth,
                        "expirationYear": expYear,
                        "CVV": CVV,
                        "threeD": {
                            "methodNotificationUrl": "https://localhost:44384/home/methodurl",//"https://3dsn.sandbox.safecharge.com/ThreeDSMethod/api/ThreeDSMethod/"
                        }
                    }
                },
                "billingAddress": {
                    "country": "GB",
                    "email": "john.smith@safecharge.com",
                },
                "urlDetails": {
                    "methodUrl": "https://localhost:44384/home/methodurl", //"https://3dsn.sandbox.safecharge.com/ThreeDSMethod/api/ThreeDSMethod",
                },
                "timeStamp": timestamp,
                "checksum": checksum
            };

            $.ajax({
                method: "POST",
                url: "https://ppp-test.safecharge.com/ppp/api/v1/initPayment.do",
                data: JSON.stringify(request),
                contentType: "application/json",
                success: function (response) {
                    console.log(response);
                    alert("PAYMENT INIT OK!");
                    var methodUrl = response.paymentOption.card.threeD.methodUrl; "https://3dsn.sandbox.safecharge.com/ThreeDSMethod/api/ThreeDSMethod/threeDSMethodURL";
                    var methodPayload = response.paymentOption.card.threeD.methodPayload;

                    console.log(methodUrl);
                    console.log(methodPayload);

                    console.log("Browser fingerprinting...");
                    var fingerpringtingform = document.getElementById("fingerprintform");
                    fingerpringtingform.action = methodUrl;
                    var input = document.getElementById("fingerprintinput");
                    input.value = methodPayload;
                    fingerpringtingform.submit();
                    console.log("Browser fingerprinting done!");

                    setTimeout(() => {
                        var paymentRequest1 = {
                            "sessionToken": "@Model.SessionToken",
                            "merchantId": "@Model.MerchantId",
                            "merchantSiteId": "@Model.MerchantSiteId",
                            "clientRequestId": "@Model.ClientRequestId",
                            "currency": currency,
                            "amount": amount,
                            "relatedTransactionId": response.transactionId,
                            //"transactionType": "Auth",
                            "billingAddress": {
                                "country": "GB",
                                "email": "someemail@somedomain.com"
                            },
                            "paymentOption": {
                                //"userPaymentoptionId": response.userPaymentoptionId,
                                "card": {
                                    "cardNumber": cardNumber,
                                    "cardHolderName": cardholderName,
                                    "expirationMonth": expMonth,
                                    "expirationYear": expYear,
                                    "CVV": "122",
                                    "threeD": {
                                        "methodCompletionInd": "U",
                                        "version": "2.1.0",
                                        "notificationURL": "https://3dsecuresafecharge.000webhostapp.com/3Dv2/notificationUrl.php",
                                        "merchantURL": "http://www.The-Merchant-Website-Fully-Quallified-URL.com",
                                        "platformType": "02",
                                        "browserDetails": {
                                            "acceptHeader": "text/html,application/xhtml+xml",
                                            "ip": "192.168.1.11",
                                            "javaEnabled": "TRUE",
                                            "javaScriptEnabled": "TRUE",
                                            "language": "EN",
                                            "colorDepth": "48",
                                            "screenHeight": "400",
                                            "screenWidth": "600",
                                            "timeZone": "0",
                                            "userAgent": "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47"
                                        }
                                    }
                                }
                            },
                            "deviceDetails": {
                                "ipAddress": "10.0.0.193"
                            },
                            "timeStamp": timestamp,
                            "checksum": checksumForPayment
                        };

                        $.ajax({
                            method: "POST",
                            url: "https://ppp-test.safecharge.com/ppp/api/v1/payment.do",
                            data: JSON.stringify(paymentRequest1),
                            contentType: "application/json",
                            success: function (response1) {
                                console.log(response1);
                                if (response1.transactionStatus === "REDIRECT") {
                                    console.log("Challenge needed!");
                                    var acsUrl = response1.paymentOption.card.threeD.acsUrl;
                                    var cReq = response1.paymentOption.card.threeD.cReq;
                                    var url = "https://3dsecuresafecharge.000webhostapp.com/3Dv2/showUrl.php?acsUrl=" + acsUrl + "&creq=" + cReq;
                                    console.log(url);

                                    var win = window.open(url, "_blank");
                                    alert("Waiting for challenge result...");

                                    alert("Challenge Done!");
                                    var paymentRequest2 = {
                                        "sessionToken": "@Model.SessionToken",
                                        "merchantId": "@Model.MerchantId",
                                        "merchantSiteId": "@Model.MerchantSiteId",
                                        "clientRequestId": "@Model.ClientRequestId",
                                        "currency": currency,
                                        "amount": amount,
                                        "relatedTransactionId": response1.transactionId,
                                        "transactionType": "Auth",
                                        "billingAddress": {
                                            "country": "GB",
                                            "email": "someemail@somedomain.com"
                                        },
                                        "paymentOption": {
                                            "card": {
                                                "cardNumber": cardNumber,
                                                "cardHolderName": cardholderName,
                                                "expirationMonth": expMonth,
                                                "expirationYear": expYear,
                                                "CVV": "122",
                                            },
                                        },
                                        "deviceDetails": {
                                            "ipAddress": "10.0.0.193"
                                        },
                                        "timeStamp": timestamp,
                                        "checksum": checksumForPayment
                                    };
                                    console.log(paymentRequest2);
                                    $.ajax({
                                        method: "POST",
                                        url: "https://ppp-test.safecharge.com/ppp/api/v1/payment.do",
                                        data: JSON.stringify(paymentRequest2),
                                        contentType: "application/json",
                                        success: function (response) {
                                            console.log(response);
                                            alert("OK");
                                        },
                                    });
                                } else {
                                    alert("OK");
                                    console.log(response);
                                }
                            }
                        });
                    }, 9000);
                }
            })
        }
    </script>
}

